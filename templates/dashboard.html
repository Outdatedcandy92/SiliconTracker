{% extends "base.html" %}

{% block title %}Dashboard - Grounded Tracker{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto fade-in">
    <!-- Top Bar with Welcome Message and Actions -->
    <div class="glass-card p-8 mb-8 animate__animated animate__fadeIn">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <div class="flex items-center gap-3">
                    <i class='bx bx-code-block text-primary-400 text-3xl'></i>
                    <h1 class="text-3xl font-bold text-white">Welcome, {{ user.user_name }}!</h1>
                </div>
                <p class="text-gray-200 mt-2">Track your development journey and reflect on your progress</p>
            </div>
            <div class="flex gap-4">
                <a href="{{ url_for('create_log') }}" class="btn-primary px-6 py-3 text-white rounded-lg font-semibold flex items-center gap-2 shadow-lg">
                    <i class='bx bx-plus'></i> Create Dev Log
                </a>
                <a href="{{ url_for('logout') }}" class="bg-slate-700 hover:bg-slate-600 px-6 py-3 text-white rounded-lg font-semibold flex items-center gap-2 transition-all duration-300 shadow-lg">
                    <i class='bx bx-log-out'></i> Logout
                </a>
            </div>
        </div>
    </div>
    
    <div class="glass-card p-8 animate__animated animate__fadeIn animate__delay-1s">
        <div class="flex items-center gap-3 mb-6">
            <i class='bx bx-history text-primary-400 text-2xl'></i>
            <h2 class="text-2xl font-bold text-white">Recent Dev Logs</h2>
        </div>
        <div id="logs-container" class="space-y-6">
            <div class="flex justify-center items-center py-8">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-400"></div>
                <p class="text-gray-200 ml-4">Loading your dev logs...</p>
            </div>
        </div>
    </div>
</div>

<script>
// Check for updated flag in URL
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('updated') === 'true') {
    const flashMessage = document.createElement('div');
    flashMessage.className = 'mb-4 p-4 rounded-lg bg-primary-500 text-white shadow-md animate__animated animate__fadeIn flex items-center';
    flashMessage.innerHTML = `
        <i class='bx bx-check-circle text-2xl mr-2'></i>
        <span>Dev log updated successfully!</span>
    `;
    document.querySelector('.container').prepend(flashMessage);
    
    // Remove the parameter from URL
    window.history.replaceState({}, document.title, window.location.pathname);
    
    // Auto-remove the message after 5 seconds
    setTimeout(() => {
        flashMessage.classList.add('animate__fadeOut');
        setTimeout(() => {
            flashMessage.remove();
        }, 500);
    }, 4500);
}

// Format date function
function formatDate(dateString) {
    const date = new Date(dateString);
    if (isNaN(date)) return '';
    
    const now = new Date();
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);
    
    if (diffDay > 0) {
        return diffDay === 1 ? 'Yesterday' : `${diffDay} days ago`;
    } else if (diffHour > 0) {
        return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
    } else if (diffMin > 0) {
        return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
    } else {
        return 'Just now';
    }
}

// Get tag color based on project tag
function getTagColor(tag) {
    const colors = {
        'CAD': 'bg-blue-500',
        'PCB': 'bg-purple-500',
        'Hardware': 'bg-orange-500',
        'Software': 'bg-emerald-500',
        '3D Printing': 'bg-pink-500',
        'Research': 'bg-indigo-500'
    };
    
    return colors[tag] || 'bg-primary-500';
}

// Load recent logs
fetch('/api/logs')
    .then(response => response.json())
    .then(logs => {
        const container = document.getElementById('logs-container');
        if (logs.length === 0) {
            container.innerHTML = `
                <div class="text-center py-10 animate__animated animate__fadeIn">
                    <i class='bx bx-notepad text-5xl text-gray-400 mb-4'></i>
                    <p class="text-gray-300 text-lg">No dev logs yet. Create your first one!</p>
                    <a href="{{ url_for('create_log') }}" class="btn-primary inline-block mt-4 px-6 py-2 text-white rounded-lg font-semibold">
                        <i class='bx bx-plus mr-1'></i> Create Dev Log
                    </a>
                </div>
            `;
            return;
        }
        
        container.innerHTML = logs.map((log, index) => {
            const tagColor = getTagColor(log.fields['Project Tag']);
            const createdDate = log.fields['Created At'] ? formatDate(log.fields['Created At']) : '';
            const animationDelay = index < 5 ? `animate__delay-${index+1}s` : '';
            
            return `
            <div class="glass-card p-6 rounded-lg hover:shadow-xl transition-all duration-300 animate__animated animate__fadeIn ${animationDelay}">
                <div class="flex flex-col md:flex-row justify-between items-start mb-4 gap-3">
                    <div>
                        <div class="flex items-center gap-2 mb-2">
                            <span class="${tagColor} text-white px-3 py-1 rounded-full text-sm font-medium">${log.fields['Project Tag']}</span>
                            <span class="text-gray-400 text-sm">${createdDate}</span>
                        </div>
                        <h3 class="text-white text-xl font-semibold">${log.fields['Project Name']}</h3>
                    </div>
                    <div class="flex items-center gap-4">
                        <div class="flex items-center bg-slate-800 px-3 py-1 rounded-full">
                            <i class='bx bx-time text-primary-400 mr-1'></i>
                            <span class="text-gray-200 text-sm">${log.fields['Time Spent (minutes)']} minutes</span>
                        </div>
                        <div class="flex space-x-2">
                            <a href="/edit-log?id=${log.id}" class="text-blue-400 hover:text-blue-300 bg-slate-800 p-2 rounded-full transition-all duration-300 hover:bg-slate-700">
                                <i class='bx bx-edit text-lg'></i>
                            </a>
                            <button onclick="deleteLog('${log.id}')" class="text-red-400 hover:text-red-300 bg-slate-800 p-2 rounded-full transition-all duration-300 hover:bg-slate-700">
                                <i class='bx bx-trash text-lg'></i>
                            </button>
                        </div>
                    </div>
                </div>
                
                <div class="bg-slate-800 bg-opacity-50 p-4 rounded-lg mb-4">
                    <h4 class="text-primary-300 font-medium mb-2">Description</h4>
                    <p class="text-white">${log.fields['Description']}</p>
                </div>
                
                <div class="bg-slate-800 bg-opacity-50 p-4 rounded-lg">
                    <h4 class="text-primary-300 font-medium mb-2">What I Did</h4>
                    <p class="text-gray-200">${log.fields['What I Did']}</p>
                </div>
                
                ${log.fields['Media URL'] ? `
                <div class="mt-4">
                    ${(() => {
                        const url = log.fields['Media URL'];
                        const fileExtension = url.split('.').pop().toLowerCase();
                        const imageExtensions = ['jpg', 'jpeg', 'png', 'gif', 'webp'];
                        
                        if (imageExtensions.includes(fileExtension)) {
                            return `<div class="overflow-hidden rounded-lg shadow-lg hover:shadow-xl transition-all duration-300">
                                <img src="${url}" class="w-full max-w-full max-h-[500px] object-contain hover:scale-105 transition-all duration-500" alt="Dev log media">
                            </div>`;
                        } else {
                            return `<a href="${url}" target="_blank" class="btn-primary inline-flex items-center justify-center px-6 py-3 text-white rounded-lg shadow-lg hover:shadow-primary-500/20 transition-all duration-300">
                                <i class='bx bx-file mr-2'></i> View Media File
                            </a>`;
                        }
                    })()} 
                </div>` : ''}
                
                ${(log.fields['Could Have Done Better'] || log.fields['What I Can Improve'] || log.fields['Next Steps']) ? `
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mt-4">
                    ${log.fields['Could Have Done Better'] ? `
                    <div class="bg-slate-800 bg-opacity-50 p-4 rounded-lg">
                        <h4 class="text-primary-300 font-medium mb-2">Could Have Done Better</h4>
                        <p class="text-gray-200 text-sm">${log.fields['Could Have Done Better']}</p>
                    </div>` : ''}
                    
                    ${log.fields['What I Can Improve'] ? `
                    <div class="bg-slate-800 bg-opacity-50 p-4 rounded-lg">
                        <h4 class="text-primary-300 font-medium mb-2">Can Improve</h4>
                        <p class="text-gray-200 text-sm">${log.fields['What I Can Improve']}</p>
                    </div>` : ''}
                    
                    ${log.fields['Next Steps'] ? `
                    <div class="bg-slate-800 bg-opacity-50 p-4 rounded-lg">
                        <h4 class="text-primary-300 font-medium mb-2">Next Steps</h4>
                        <p class="text-gray-200 text-sm">${log.fields['Next Steps']}</p>
                    </div>` : ''}
                </div>` : ''}
            </div>
        `}).join('');
    })
    .catch(error => {
        console.error('Error loading logs:', error);
        document.getElementById('logs-container').innerHTML = `
            <div class="text-center py-10 animate__animated animate__fadeIn">
                <i class='bx bx-error-circle text-5xl text-red-400 mb-4'></i>
                <p class="text-red-300 text-lg">Error loading dev logs.</p>
                <button onclick="window.location.reload()" class="bg-slate-700 hover:bg-slate-600 mt-4 px-6 py-2 text-white rounded-lg font-semibold">
                    <i class='bx bx-refresh mr-1'></i> Try Again
                </button>
            </div>
        `;
    });

// Function to delete a log
function deleteLog(recordId) {
    // Create a custom confirmation dialog
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate__animated animate__fadeIn';
    
    const dialog = document.createElement('div');
    dialog.className = 'glass-card p-6 rounded-lg max-w-md w-full animate__animated animate__zoomIn';
    dialog.innerHTML = `
        <div class="text-center mb-4">
            <i class='bx bx-trash text-red-400 text-4xl'></i>
            <h3 class="text-xl font-bold text-white mt-2">Delete Dev Log</h3>
            <p class="text-gray-300 mt-2">Are you sure you want to delete this dev log? This action cannot be undone.</p>
        </div>
        <div class="flex justify-center gap-4 mt-6">
            <button id="cancel-delete" class="bg-slate-700 hover:bg-slate-600 px-6 py-2 text-white rounded-lg font-semibold transition-all duration-300">
                Cancel
            </button>
            <button id="confirm-delete" class="bg-red-500 hover:bg-red-600 px-6 py-2 text-white rounded-lg font-semibold transition-all duration-300">
                Delete
            </button>
        </div>
    `;
    
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    // Handle cancel
    document.getElementById('cancel-delete').addEventListener('click', () => {
        dialog.classList.replace('animate__zoomIn', 'animate__zoomOut');
        overlay.classList.replace('animate__fadeIn', 'animate__fadeOut');
        setTimeout(() => overlay.remove(), 500);
    });
    
    // Handle confirm
    document.getElementById('confirm-delete').addEventListener('click', () => {
        // Show loading state
        document.getElementById('confirm-delete').innerHTML = `
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white mr-2"></div>
                Deleting...
            </div>
        `;
        document.getElementById('confirm-delete').disabled = true;
        
        fetch(`/api/logs/${recordId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Show success message before reloading
                dialog.innerHTML = `
                    <div class="text-center mb-4">
                        <i class='bx bx-check-circle text-primary-400 text-4xl'></i>
                        <h3 class="text-xl font-bold text-white mt-2">Success!</h3>
                        <p class="text-gray-300 mt-2">Dev log deleted successfully.</p>
                    </div>
                `;
                
                setTimeout(() => {
                    // Refresh the page to show updated list
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error(data.message || 'Failed to delete log');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            dialog.innerHTML = `
                <div class="text-center mb-4">
                    <i class='bx bx-error-circle text-red-400 text-4xl'></i>
                    <h3 class="text-xl font-bold text-white mt-2">Error</h3>
                    <p class="text-red-300 mt-2">${error.message || 'An error occurred while deleting the log'}</p>
                </div>
                <div class="flex justify-center mt-6">
                    <button id="close-error" class="bg-slate-700 hover:bg-slate-600 px-6 py-2 text-white rounded-lg font-semibold transition-all duration-300">
                        Close
                    </button>
                </div>
            `;
            
            document.getElementById('close-error').addEventListener('click', () => {
                dialog.classList.replace('animate__zoomIn', 'animate__zoomOut');
                overlay.classList.replace('animate__fadeIn', 'animate__fadeOut');
                setTimeout(() => overlay.remove(), 500);
            });
        });
    });
}
</script>
{% endblock %}