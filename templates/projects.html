{% extends "base.html" %}

{% block title %}Projects - Grounded Tracker{% endblock %}

{% block content %}
<div class="max-w-6xl mx-auto fade-in">
    <!-- Top Bar with Welcome Message and Actions -->
    <div class="glass-card p-8 mb-8 animate__animated animate__fadeIn">
        <div class="flex flex-col md:flex-row justify-between items-center gap-4">
            <div class="text-center md:text-left">
                <div class="flex items-center gap-3">
                    <i class='bx bx-code-block text-primary-400 text-3xl'></i>
                    <h1 class="text-3xl font-bold text-white">Welcome, {{ user.user_name }}!</h1>
                </div>
                <p class="text-gray-200 mt-2">Track your development journey and reflect on your progress</p>
            </div>
            <div class="flex gap-4">
                <a href="{{ url_for('create_project') }}" class="btn-primary px-6 py-3 text-white rounded-lg font-semibold flex items-center gap-2 shadow-lg">
                    <i class='bx bx-plus'></i> Create Project
                </a>
                <a href="{{ url_for('logout') }}" class="bg-slate-700 hover:bg-slate-600 px-6 py-3 text-white rounded-lg font-semibold flex items-center gap-2 transition-all duration-300 shadow-lg">
                    <i class='bx bx-log-out'></i> Logout
                </a>
            </div>
        </div>
    </div>
    
    <div class="glass-card p-8 animate__animated animate__fadeIn animate__delay-1s">
        <div class="flex items-center gap-3 mb-6">
            <i class='bx bx-folder text-primary-400 text-2xl'></i>
            <h2 class="text-2xl font-bold text-white">My Projects</h2>
        </div>
        <div id="projects-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
            <div class="flex justify-center items-center py-8 col-span-full">
                <div class="animate-spin rounded-full h-12 w-12 border-t-2 border-b-2 border-primary-400"></div>
                <p class="text-gray-200 ml-4">Loading your projects...</p>
            </div>
        </div>
    </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
if (urlParams.get('updated') === 'true') {
    const flashMessage = document.createElement('div');
    flashMessage.className = 'mb-4 p-4 rounded-lg bg-primary-500 text-white shadow-md animate__animated animate__fadeIn flex items-center';
    flashMessage.innerHTML = `
        <i class='bx bx-check-circle text-2xl mr-2'></i>
        <span>Project updated successfully!</span>
    `;
    document.querySelector('.container').prepend(flashMessage);
    
    window.history.replaceState({}, document.title, window.location.pathname);
    
    setTimeout(() => {
        flashMessage.classList.add('animate__fadeOut');
        setTimeout(() => {
            flashMessage.remove();
        }, 500);
    }, 4500);
}

function getTagColor(tag) {
    const colors = {
        'CAD': 'bg-blue-500',
        'PCB': 'bg-purple-500',
        'Hardware': 'bg-orange-500',
        'Software': 'bg-emerald-500',
        '3D Printing': 'bg-pink-500',
        'Research': 'bg-indigo-500'
    };
    
    return colors[tag] || 'bg-primary-500';
}

function formatDate(dateString) {
    const date = new Date(dateString);
    if (isNaN(date)) return '';
    
    const now = new Date();
    const diffMs = now - date;
    const diffSec = Math.floor(diffMs / 1000);
    const diffMin = Math.floor(diffSec / 60);
    const diffHour = Math.floor(diffMin / 60);
    const diffDay = Math.floor(diffHour / 24);
    
    if (diffDay > 0) {
        return diffDay === 1 ? 'Yesterday' : `${diffDay} days ago`;
    } else if (diffHour > 0) {
        return `${diffHour} hour${diffHour > 1 ? 's' : ''} ago`;
    } else if (diffMin > 0) {
        return `${diffMin} minute${diffMin > 1 ? 's' : ''} ago`;
    } else {
        return 'Just now';
    }
}

fetch('/api/projects')
    .then(response => response.json())
    .then(projects => {
        const container = document.getElementById('projects-container');
        if (projects.length === 0) {
            container.innerHTML = `
                <div class="text-center py-10 animate__animated animate__fadeIn col-span-full">
                    <i class='bx bx-folder-open text-5xl text-gray-400 mb-4'></i>
                    <p class="text-gray-300 text-lg">No projects yet. Create your first one!</p>
                    <a href="{{ url_for('create_project') }}" class="btn-primary inline-block mt-4 px-6 py-2 text-white rounded-lg font-semibold">
                        <i class='bx bx-plus mr-1'></i> Create Project
                    </a>
                </div>
            `;
            return;
        }
        
        container.innerHTML = projects.map((project, index) => {
            const tagColor = getTagColor(project.fields['Project Tag']);
            const createdDate = project.fields['Created At'] ? formatDate(project.fields['Created At']) : '';
            const animationDelay = index < 6 ? `animate__delay-${index % 3 + 1}s` : '';
            const coverImage = project.fields['Cover Image URL'] || 'https://images.unsplash.com/photo-1581472723648-909f4851d4ae?ixlib=rb-4.0.3&auto=format&fit=crop&w=1000&q=80';
            
            return `
            <div class="glass-card overflow-hidden rounded-lg hover:shadow-xl transition-all duration-300 animate__animated animate__fadeIn ${animationDelay} flex flex-col h-full">
                <div class="relative overflow-hidden h-48">
                    <img src="${coverImage}" class="w-full h-full object-cover transition-transform duration-500 hover:scale-110" alt="${project.fields['Project Name']}">
                    <div class="absolute inset-0 bg-gradient-to-t from-slate-900 to-transparent opacity-70"></div>
                    <div class="absolute bottom-0 left-0 p-4 w-full">
                        <div class="flex items-center justify-between">
                            <span class="${tagColor} text-white px-3 py-1 rounded-full text-sm font-medium">${project.fields['Project Tag']}</span>
                            <span class="text-gray-300 text-sm">${createdDate}</span>
                        </div>
                        <h3 class="text-white text-xl font-bold mt-2 truncate">${project.fields['Project Name']}</h3>
                    </div>
                </div>
                
                <div class="p-4 flex-grow">
                    <p class="text-gray-300 line-clamp-3 h-18 overflow-hidden">${project.fields['Description'] || 'No description provided.'}</p>
                </div>
                
                <div class="p-4 pt-0 flex justify-between items-center">
                    <a href="/project/${project.id}" class="btn-primary px-4 py-2 text-white rounded-lg text-sm font-medium flex items-center gap-1">
                        <i class='bx bx-folder-open'></i> View Project
                    </a>
                    <div class="flex space-x-2">
                        <a href="/edit-project?id=${project.id}" class="text-blue-400 hover:text-blue-300 bg-slate-800 p-2 rounded-full transition-all duration-300 hover:bg-slate-700">
                            <i class='bx bx-edit text-lg'></i>
                        </a>
                        <button onclick="deleteProject('${project.id}')" class="text-red-400 hover:text-red-300 bg-slate-800 p-2 rounded-full transition-all duration-300 hover:bg-slate-700">
                            <i class='bx bx-trash text-lg'></i>
                        </button>
                    </div>
                </div>
            </div>
            `;
        }).join('');
    })
    .catch(error => {
        console.error('Error loading projects:', error);
        document.getElementById('projects-container').innerHTML = `
            <div class="text-center py-10 animate__animated animate__fadeIn col-span-full">
                <i class='bx bx-error-circle text-5xl text-red-400 mb-4'></i>
                <p class="text-red-300 text-lg">Error loading projects.</p>
                <button onclick="window.location.reload()" class="bg-slate-700 hover:bg-slate-600 mt-4 px-6 py-2 text-white rounded-lg font-semibold">
                    <i class='bx bx-refresh mr-1'></i> Try Again
                </button>
            </div>
        `;
    });

function deleteProject(recordId) {
    const overlay = document.createElement('div');
    overlay.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 animate__animated animate__fadeIn';
    
    const dialog = document.createElement('div');
    dialog.className = 'glass-card p-6 rounded-lg max-w-md w-full animate__animated animate__zoomIn';
    dialog.innerHTML = `
        <div class="text-center mb-4">
            <i class='bx bx-trash text-red-400 text-4xl'></i>
            <h3 class="text-xl font-bold text-white mt-2">Delete Project</h3>
            <p class="text-gray-300 mt-2">Are you sure you want to delete this project? This action cannot be undone.</p>
            <p class="text-red-300 mt-2">Note: This will not delete the associated dev logs.</p>
        </div>
        <div class="flex justify-center gap-4 mt-6">
            <button id="cancel-delete" class="bg-slate-700 hover:bg-slate-600 px-6 py-2 text-white rounded-lg font-semibold transition-all duration-300">
                Cancel
            </button>
            <button id="confirm-delete" class="bg-red-500 hover:bg-red-600 px-6 py-2 text-white rounded-lg font-semibold transition-all duration-300">
                Delete
            </button>
        </div>
    `;
    
    overlay.appendChild(dialog);
    document.body.appendChild(overlay);
    
    document.getElementById('cancel-delete').addEventListener('click', () => {
        dialog.classList.replace('animate__zoomIn', 'animate__zoomOut');
        overlay.classList.replace('animate__fadeIn', 'animate__fadeOut');
        setTimeout(() => overlay.remove(), 500);
    });
    
    document.getElementById('confirm-delete').addEventListener('click', () => {
        document.getElementById('confirm-delete').innerHTML = `
            <div class="flex items-center">
                <div class="animate-spin rounded-full h-4 w-4 border-t-2 border-b-2 border-white mr-2"></div>
                Deleting...
            </div>
        `;
        document.getElementById('confirm-delete').disabled = true;
        
        fetch(`/api/projects/${recordId}`, {
            method: 'DELETE'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                dialog.innerHTML = `
                    <div class="text-center mb-4">
                        <i class='bx bx-check-circle text-primary-400 text-4xl'></i>
                        <h3 class="text-xl font-bold text-white mt-2">Success!</h3>
                        <p class="text-gray-300 mt-2">Project deleted successfully.</p>
                    </div>
                `;
                
                setTimeout(() => {
                    window.location.reload();
                }, 1000);
            } else {
                throw new Error(data.message || 'Failed to delete project');
            }
        })
        .catch(error => {
            console.error('Error:', error);
            dialog.innerHTML = `
                <div class="text-center mb-4">
                    <i class='bx bx-error-circle text-red-400 text-4xl'></i>
                    <h3 class="text-xl font-bold text-white mt-2">Error</h3>
                    <p class="text-red-300 mt-2">${error.message || 'An error occurred while deleting the project'}</p>
                </div>
                <div class="flex justify-center mt-6">
                    <button id="close-error" class="bg-slate-700 hover:bg-slate-600 px-6 py-2 text-white rounded-lg font-semibold transition-all duration-300">
                        Close
                    </button>
                </div>
            `;
            
            document.getElementById('close-error').addEventListener('click', () => {
                dialog.classList.replace('animate__zoomIn', 'animate__zoomOut');
                overlay.classList.replace('animate__fadeIn', 'animate__fadeOut');
                setTimeout(() => overlay.remove(), 500);
            });
        });
    });
}
</script>
{% endblock %}